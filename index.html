<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stock Analyzer - Smart Inventory</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --accent: #4ADE80; --accent-hover: #22C55E; --accent-dim: rgba(74,222,128,0.08);
      --blue: #60A5FA; --purple: #A78BFA; --orange: #FB923C;
      --bg: #0C0F14; --bg-raised: #111520; --card: #151921; --card-hover: #1A2030;
      --text: #E2E8F0; --text-sec: #94A3B8; --text-dim: #64748B;
      --border: #252D3A; --border-hover: #3B4A5E;
      --success: #4ADE80; --danger: #F87171; --warn: #FBBF24;
      --radius: 12px; --radius-sm: 8px;
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.5; min-height: 100vh;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    #root { min-height: 100vh; }

    /* ── Animations ── */
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }

    /* ── Layout ── */
    .app { min-height: 100vh; display: flex; flex-direction: column; }
    .container { max-width: 1240px; margin: 0 auto; padding: 0 28px; width: 100%; }
    .header {
      background: rgba(12,15,20,0.8); backdrop-filter: blur(16px) saturate(180%);
      border-bottom: 1px solid var(--border); padding: 14px 0;
      position: sticky; top: 0; z-index: 100;
    }
    .header-inner { display: flex; align-items: center; justify-content: center; position: relative; }
    .header-title {
      font-size: 28px; font-weight: 800; color: var(--accent);
      letter-spacing: -0.5px;
      font-family: 'JetBrains Mono', 'Roboto Mono', monospace;
      text-align: center;
    }
    .header-actions { position: absolute; right: 0; display: flex; gap: 8px; align-items: center; }
    .main { flex: 1; padding: 28px 0; }

    /* ── Buttons ── */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 9px 18px; border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 600; cursor: pointer;
      border: 1px solid transparent; transition: all .2s;
      font-family: inherit; letter-spacing: 0.01em;
    }
    .btn:disabled { opacity: .4; cursor: not-allowed; }
    .btn-primary {
      background: var(--accent); color: #0C0F14; border-color: var(--accent);
    }
    .btn-primary:hover:not(:disabled) { background: var(--accent-hover); border-color: var(--accent-hover); transform: translateY(-1px); }
    .btn-outline {
      border-color: var(--border); background: var(--card); color: var(--text);
    }
    .btn-outline:hover:not(:disabled) { border-color: var(--border-hover); background: var(--card-hover); }
    .btn-danger { background: rgba(248,113,113,0.12); color: var(--danger); border-color: rgba(248,113,113,0.2); }
    .btn-danger:hover:not(:disabled) { background: rgba(248,113,113,0.2); }
    .btn-sm { padding: 5px 10px; font-size: 11px; }
    .btn-icon {
      padding: 7px; border: none; background: none; cursor: pointer;
      color: var(--text-dim); border-radius: 6px; transition: all .2s;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.06); color: var(--text); }

    /* ── Inputs ── */
    .input {
      width: 100%; padding: 10px 14px;
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-size: 13px; color: var(--text); background: var(--bg-raised);
      transition: border-color .2s; outline: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(74,222,128,0.1); }
    .input::placeholder { color: var(--text-dim); }
    .input-sm { padding: 6px 10px; font-size: 12px; }
    .input-group { display: flex; flex-direction: column; gap: 6px; }
    .input-label { font-size: 12px; font-weight: 500; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.5px; }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 200; backdrop-filter: blur(8px);
    }
    .modal {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); width: 90%; max-height: 85vh;
      overflow-y: auto; animation: fadeUp .3s ease-out;
    }
    .modal::-webkit-scrollbar { width: 6px; }
    .modal::-webkit-scrollbar-track { background: transparent; }
    .modal::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    .modal-sm { max-width: 480px; }
    .modal-md { max-width: 640px; }
    .modal-lg { max-width: 920px; }
    .modal-header { padding: 24px 28px 0; }
    .modal-header h2 { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
    .modal-header p { font-size: 13px; color: var(--text-sec); margin-top: 6px; }
    .modal-body { padding: 24px 28px; }
    .modal-footer { padding: 0 28px 24px; display: flex; justify-content: flex-end; gap: 10px; }

    /* ── Search ── */
    .search-wrap { position: relative; margin-bottom: 28px; }
    .search-input { padding-left: 42px; font-size: 14px; font-family: 'Inter', sans-serif; }
    .search-icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); color: var(--text-dim); pointer-events: none; }
    .search-spinner { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); }
    .search-results {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0;
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); max-height: 300px; overflow-y: auto; z-index: 50;
    }
    .search-item {
      padding: 11px 16px; cursor: pointer; display: flex;
      justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border); font-size: 13px;
      transition: background .15s;
    }
    .search-item:last-child { border-bottom: none; }
    .search-item:hover { background: var(--accent-dim); }
    .search-item-ticker {
      font-weight: 700; color: var(--accent);
      font-family: 'JetBrains Mono', monospace; font-size: 13px;
    }
    .search-item-name { color: var(--text-sec); font-size: 12px; text-align: right; max-width: 60%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── Watchlist ── */
    .watchlist { display: flex; flex-direction: column; gap: 8px; }
    .watchlist-empty { text-align: center; padding: 80px 20px; color: var(--text-dim); }
    .watchlist-empty p { margin-top: 8px; font-size: 13px; }
    .wl-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; background: var(--card);
      border-radius: var(--radius); border: 1px solid var(--border);
      cursor: pointer; transition: all .2s;
      animation: fadeUp .4s ease-out both;
    }
    .wl-item:hover { border-color: var(--border-hover); transform: translateY(-2px); background: var(--card-hover); }
    .wl-item-left { display: flex; align-items: center; gap: 16px; }
    .wl-item-ticker {
      font-weight: 700; font-size: 15px; min-width: 72px;
      font-family: 'JetBrains Mono', monospace; color: var(--accent);
    }
    .wl-item-name { color: var(--text-sec); font-size: 13px; }
    .wl-item-right { display: flex; align-items: center; gap: 8px; }

    /* ── Detail Header ── */
    .detail-header {
      display: flex; align-items: center; gap: 16px;
      margin-bottom: 28px; animation: fadeUp .4s ease-out;
    }
    .detail-title { font-size: 26px; font-weight: 700; letter-spacing: -0.5px; }
    .detail-ticker {
      font-size: 13px; color: var(--accent); font-weight: 600;
      background: var(--accent-dim); padding: 5px 14px; border-radius: 20px;
      font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;
    }

    /* ── Metrics Grid ── */
    .metrics-grid {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 28px;
    }
    .metric-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 18px 20px;
      transition: all .2s; animation: fadeUp .4s ease-out both;
    }
    .metric-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
    .metric-label {
      font-size: 11px; font-weight: 600; color: var(--text-dim);
      text-transform: uppercase; letter-spacing: .8px; margin-bottom: 8px;
    }
    .metric-value {
      font-size: 22px; font-weight: 700;
      font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px;
    }
    .metric-input {
      width: 100%; padding: 4px 8px;
      border: 1px dashed var(--border); border-radius: 4px;
      font-size: 20px; font-weight: 700; color: var(--text);
      background: transparent; outline: none;
      font-family: 'JetBrains Mono', monospace;
    }
    .metric-input:focus { border-color: var(--accent); border-style: solid; background: rgba(74,222,128,0.05); }
    .metric-calc { font-size: 11px; color: var(--text-dim); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }

    /* ── AI Panel ── */
    .ai-panel {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 24px; margin-bottom: 28px;
      animation: fadeUp .5s ease-out both;
    }
    .ai-panel h3 { font-size: 15px; font-weight: 700; margin-bottom: 14px; letter-spacing: -0.2px; }
    .ai-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 14px; }
    .ai-tag {
      padding: 5px 14px; border-radius: 20px;
      font-size: 12px; font-weight: 600; letter-spacing: 0.2px;
    }
    .ai-tag-blue { background: rgba(96,165,250,0.1); color: var(--blue); }
    .ai-tag-amber { background: rgba(251,191,36,0.1); color: var(--warn); }
    .ai-intro { font-size: 13px; color: var(--text-sec); margin-bottom: 16px; line-height: 1.7; }
    .ai-bullets { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .ai-bullet {
      display: flex; gap: 8px; font-size: 13px;
      padding: 10px 14px; border-radius: var(--radius-sm);
      border: 1px solid transparent;
    }
    .ai-pro {
      background: rgba(74,222,128,0.06); color: var(--success);
      border-color: rgba(74,222,128,0.12);
    }
    .ai-con {
      background: rgba(248,113,113,0.06); color: var(--danger);
      border-color: rgba(248,113,113,0.12);
    }
    .ai-loading { text-align: center; padding: 24px; color: var(--text-dim); }

    /* ── Charts Grid ── */
    .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
    .chart-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      transition: all .2s; animation: fadeUp .4s ease-out both;
    }
    .chart-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
    .chart-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 14px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.4px; }
    .chart-empty {
      height: 200px; display: flex; align-items: center; justify-content: center;
      color: var(--text-dim); font-size: 12px;
      background: var(--bg-raised); border-radius: var(--radius-sm);
      border: 1px dashed var(--border);
    }
    .chart-canvas-wrap { position: relative; height: 250px; }
    .chart-canvas-wrap canvas { width: 100% !important; height: 100% !important; }

    /* ── Supplement Section ── */
    .supplement { margin-bottom: 28px; }
    .supplement-toggle {
      display: flex; align-items: center; gap: 8px; cursor: pointer;
      padding: 14px 18px; background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-sm); font-size: 13px; font-weight: 600;
      width: 100%; color: var(--text); transition: all .2s;
    }
    .supplement-toggle:hover { background: var(--card-hover); border-color: var(--border-hover); }
    .supplement-body { margin-top: 14px; }

    /* ── Pie Grid ── */
    .pie-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
    .pie-card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px;
      transition: all .2s; animation: fadeUp .4s ease-out both;
    }
    .pie-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
    .pie-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 14px; color: var(--text-sec); text-transform: uppercase; letter-spacing: 0.4px; }
    .pie-canvas-wrap { position: relative; height: 260px; }
    .pie-canvas-wrap canvas { width: 100% !important; height: 100% !important; }

    /* ── Price Alert List ── */
    .alert-section { margin-bottom: 28px; animation: fadeUp .4s ease-out both; }
    .alert-list { display: flex; flex-direction: column; gap: 6px; margin-top: 14px; }
    .alert-row {
      display: grid; grid-template-columns: 100px 80px 1fr;
      gap: 14px; padding: 12px 16px; background: var(--card);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-size: 12px; align-items: center; transition: all .2s;
      font-family: 'JetBrains Mono', monospace;
    }
    .alert-row:hover { border-color: var(--border-hover); }
    .alert-date { font-weight: 600; color: var(--text-sec); }
    .alert-change { font-weight: 700; text-align: center; padding: 3px 10px; border-radius: 6px; font-size: 12px; }
    .alert-up { background: rgba(74,222,128,0.08); color: var(--success); }
    .alert-down { background: rgba(248,113,113,0.08); color: var(--danger); }
    .alert-news { color: var(--text-sec); font-family: 'Inter', sans-serif; }

    /* ── Data Checklist ── */
    .checklist { display: flex; flex-direction: column; gap: 8px; }
    .checklist-item {
      padding: 14px 16px; background: var(--bg-raised);
      border: 1px solid var(--border); border-radius: var(--radius-sm);
      font-size: 13px; transition: border-color .2s;
    }
    .checklist-item:hover { border-color: var(--border-hover); }
    .checklist-item-header { display: flex; align-items: center; gap: 12px; }
    .checklist-ok { color: var(--success); font-weight: 700; font-size: 15px; }
    .checklist-miss { color: var(--danger); font-weight: 700; font-size: 15px; }
    .checklist-warn { color: var(--warn); font-weight: 700; font-size: 15px; }
    .checklist-label { flex: 1; font-weight: 500; }
    .checklist-detail {
      font-size: 11px; color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace;
    }
    .checklist-input-grid { margin-top: 12px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
    .checklist-year-cell { display: flex; flex-direction: column; align-items: center; gap: 3px; }
    .checklist-year-cell span {
      font-size: 10px; color: var(--text-dim); font-weight: 600;
      font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;
    }
    .checklist-year-cell .input { padding: 5px 6px; font-size: 11px; text-align: center; }
    .checklist-year-cell .input.has-api-val {
      background: rgba(74,222,128,0.06); border-color: rgba(74,222,128,0.2);
      color: var(--success);
    }
    .checklist-dist-rows { margin-top: 12px; display: flex; flex-direction: column; gap: 6px; }
    .checklist-dist-row { display: flex; gap: 8px; align-items: center; }
    .checklist-dist-row .input { flex: 1; }
    .checklist-dist-row .btn { flex-shrink: 0; }

    /* ── Footer ── */
    .detail-footer {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 24px; margin-bottom: 28px;
      animation: fadeUp .4s ease-out both;
    }
    .detail-footer h4 { font-size: 13px; font-weight: 700; margin-bottom: 10px; color: var(--warn); text-transform: uppercase; letter-spacing: 0.5px; }
    .detail-footer ul { list-style: none; display: flex; flex-direction: column; gap: 6px; }
    .detail-footer li { font-size: 12px; color: var(--text-sec); padding-left: 16px; position: relative; }
    .detail-footer li::before { content: '\2022'; position: absolute; left: 0; color: var(--warn); }

    /* ── Utilities ── */
    .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin .6s linear infinite; }
    .spinner-lg { width: 32px; height: 32px; border-width: 3px; }
    .loading-overlay {
      position: fixed; inset: 0; background: rgba(12,15,20,.92);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 150; gap: 14px; backdrop-filter: blur(4px);
    }
    .loading-text { font-size: 13px; color: var(--text-sec); font-family: 'JetBrains Mono', monospace; }
    .text-center { text-align: center; }
    .text-sec { color: var(--text-sec); }
    .mt-2 { margin-top: 8px; }
    .mt-4 { margin-top: 16px; }
    .mb-4 { margin-bottom: 16px; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .gap-2 { gap: 8px; }
    .hidden { display: none; }

    /* ── Scrollbar ── */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

    /* ── Responsive ── */
    @media (max-width: 768px) {
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .charts-grid { grid-template-columns: 1fr; }
      .pie-grid { grid-template-columns: 1fr; }
      .ai-bullets { grid-template-columns: 1fr; }
      .alert-row { grid-template-columns: 80px 60px 1fr; font-size: 11px; }
      .container { padding: 0 16px; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
// ============================================================
// Stock Analyzer - Full Application
// ============================================================
const { useState, useEffect, useRef, useCallback, useMemo } = React;

// ============================================================
// SECTION 1: CONFIGURATION
// ============================================================
const FMP_STABLE = 'https://financialmodelingprep.com/stable';
const CLAUDE_URL = 'https://api.anthropic.com/v1/messages';
const OPENROUTER_URL = 'https://openrouter.ai/api/v1/chat/completions';
const FINNHUB = 'https://finnhub.io/api/v1';
const CURRENT_YEAR = new Date().getFullYear();
const DATA_YEARS = 15;

const CHECKLIST_ITEMS = [
  { key: 'pe15', label: '15Y PE Ratio History', type: 'history' },
  { key: 'ps15', label: '15Y PS Ratio History', type: 'history' },
  { key: 'ebitda15', label: '15Y EBITDA History', type: 'history', fmt: 'big' },
  { key: 'mktcap15', label: '15Y Market Cap History', type: 'history', fmt: 'big' },
  { key: 'fcf15', label: '15Y Free Cash Flow History', type: 'history', fmt: 'big' },
  { key: 'price', label: 'Current Price (Previous Close)', type: 'single' },
  { key: 'eps', label: 'Current EPS (TTM)', type: 'single' },
  { key: 'shares', label: 'Shares Outstanding', type: 'single', fmt: 'big' },
  { key: 'egr', label: 'Expected Growth Rate (%)', type: 'single' },
  { key: 'geo', label: 'Revenue by Geographic Region', type: 'distribution' },
  { key: 'seg', label: 'Revenue by Business Segment', type: 'distribution' },
  { key: 'prices1y', label: '1Y Daily Price Data', type: 'priceSeries' },
  { key: 'sig5', label: 'Significant Days (>5% Change)', type: 'readonly' },
];

const CHART_COLORS = ['#4ADE80','#60A5FA','#A78BFA','#FB923C','#F87171','#22D3EE','#818CF8','#F472B6'];
const PIE_COLORS = ['#4ADE80','#60A5FA','#A78BFA','#FB923C','#F87171','#22D3EE','#818CF8','#F472B6','#FBBF24','#34D399'];

// ============================================================
// SECTION 2: LOCAL STORAGE
// ============================================================
function getStore(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
  catch { return fallback; }
}
function setStore(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
function getApiKeys() { return { fmp: 'ItgCk9X8nLUvYSqIn69qRoMQHlyAoJTz', claude: '', finnhub: 'd6h4if9r01qnjncnb3fg', openrouter: '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', aiProvider: 'openrouter' }; }
function setApiKeys(k) { /* no-op: always use default keys */ }
function getWatchlist() { return getStore('sa_watchlist', []); }
function setWatchlist(l) { setStore('sa_watchlist', l); }
function getOverrides(ticker) { return getStore('sa_ov_' + ticker, {}); }
function setOverrides(ticker, o) { setStore('sa_ov_' + ticker, o); }
function getUserInputs(ticker) { return getStore('sa_inputs_' + ticker, {}); }
function saveUserInputs(ticker, inputs) { setStore('sa_inputs_' + ticker, inputs); }
function getStockCache(ticker) { return getStore('sa_cache_' + ticker, null); }
function setStockCache(ticker, d) { setStore('sa_cache_' + ticker, d); }

// ============================================================
// SECTION 3: API FUNCTIONS
// ============================================================
async function fmpGet(path, key) {
  const sep = path.includes('?') ? '&' : '?';
  const r = await fetch(`${FMP_STABLE}${path}${sep}apikey=${key}`);
  if (!r.ok) throw new Error(`FMP error ${r.status}`);
  return r.json();
}
async function searchTickers(query, key) {
  const q = encodeURIComponent(query);
  const [bySymbol, byName] = await Promise.all([
    fmpGet(`/search-symbol?query=${q}&limit=5`, key),
    fmpGet(`/search-name?query=${q}&limit=5`, key)
  ]);
  // Merge and deduplicate results, map to consistent format
  const seen = new Set();
  const merged = [];
  for (const item of [...(bySymbol || []), ...(byName || [])]) {
    if (!seen.has(item.symbol)) {
      seen.add(item.symbol);
      merged.push({ symbol: item.symbol, name: item.name, exchangeShortName: item.exchange || '' });
    }
  }
  return merged;
}

async function fetchProfile(ticker, key) {
  const d = await fmpGet(`/profile?symbol=${ticker}`, key);
  return d && d[0] ? d[0] : null;
}

async function fetchIncomeStatements(ticker, key) {
  return fmpGet(`/income-statement?symbol=${ticker}&period=annual&limit=${DATA_YEARS}`, key);
}

async function fetchKeyMetrics(ticker, key) {
  return fmpGet(`/key-metrics?symbol=${ticker}&period=annual&limit=${DATA_YEARS}`, key);
}

async function fetchEnterpriseValues(ticker, key) {
  return fmpGet(`/enterprise-values?symbol=${ticker}&limit=${DATA_YEARS}`, key);
}

async function fetchCashFlowStatements(ticker, key) {
  return fmpGet(`/cash-flow-statement?symbol=${ticker}&period=annual&limit=${DATA_YEARS}`, key);
}

async function fetchRatios(ticker, key) {
  return fmpGet(`/ratios?symbol=${ticker}&period=annual&limit=${DATA_YEARS}`, key);
}

async function fetchHistoricalPrices(ticker, key) {
  const to = new Date().toISOString().slice(0, 10);
  const from = new Date(Date.now() - 365 * 86400000).toISOString().slice(0, 10);
  const d = await fmpGet(`/historical-price-eod/full?symbol=${ticker}&from=${from}&to=${to}`, key);
  return Array.isArray(d) ? d : (d && d.historical ? d.historical : []);
}

async function fetchFmpNews(ticker, key, limit = 50) {
  return fmpGet(`/news/stock?symbols=${ticker}&limit=${limit}`, key);
}

async function fetchGeoRevenue(ticker, key) {
  try { return await fmpGet(`/revenue-geographic-segmentation?symbol=${ticker}&structure=flat`, key); }
  catch { return null; }
}

async function fetchSegRevenue(ticker, key) {
  try { return await fmpGet(`/revenue-product-segmentation?symbol=${ticker}&structure=flat`, key); }
  catch { return null; }
}

async function fetchFinnhubNews(ticker, dateStr, finnhubKey) {
  const r = await fetch(`${FINNHUB}/company-news?symbol=${ticker}&from=${dateStr}&to=${dateStr}&token=${finnhubKey}`);
  if (!r.ok) return [];
  return r.json();
}

// Fetch all stock data in parallel
async function fetchAllStockData(ticker, keys) {
  const results = {};
  const tasks = [
    fetchProfile(ticker, keys.fmp).then(d => results.profile = d).catch(() => results.profile = null),
    fetchIncomeStatements(ticker, keys.fmp).then(d => results.income = d).catch(() => results.income = []),
    fetchKeyMetrics(ticker, keys.fmp).then(d => results.metrics = d).catch(() => results.metrics = []),
    fetchEnterpriseValues(ticker, keys.fmp).then(d => results.ev = d).catch(() => results.ev = []),
    fetchCashFlowStatements(ticker, keys.fmp).then(d => results.cashflow = d).catch(() => results.cashflow = []),
    fetchHistoricalPrices(ticker, keys.fmp).then(d => results.prices1y = d).catch(() => results.prices1y = []),
    fetchRatios(ticker, keys.fmp).then(d => results.ratios = d).catch(() => results.ratios = []),
    fetchGeoRevenue(ticker, keys.fmp).then(d => results.geo = d).catch(() => results.geo = null),
    fetchSegRevenue(ticker, keys.fmp).then(d => results.seg = d).catch(() => results.seg = null),
  ];
  await Promise.all(tasks);
  // Stable API profile lacks eps & sharesOutstanding; derive from other data
  if (results.profile) {
    if (results.profile.eps == null && results.income && results.income[0]) {
      results.profile.eps = results.income[0].epsDiluted || results.income[0].eps || null;
    }
    if (results.profile.sharesOutstanding == null && results.ev && results.ev[0]) {
      results.profile.sharesOutstanding = results.ev[0].numberOfShares || null;
    }
  }
  return results;
}

// AI helper: call Claude Messages API
async function callClaude(prompt, claudeKey, maxTokens = 1024) {
  const r = await fetch(CLAUDE_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': claudeKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }],
    }),
  });
  if (!r.ok) {
    const err = await r.text().catch(() => '');
    throw new Error(`Claude API error ${r.status}: ${err}`);
  }
  const d = await r.json();
  return (d.content && d.content[0] && d.content[0].text) ? d.content[0].text.trim() : '';
}

// AI helper: call OpenRouter API (OpenAI-compatible)
async function callOpenRouter(prompt, openrouterKey, maxTokens = 1024) {
  const r = await fetch(OPENROUTER_URL, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${openrouterKey}`,
      'HTTP-Referer': window.location.origin,
      'X-OpenRouter-Title': 'Stock Analyzer',
    },
    body: JSON.stringify({
      model: 'anthropic/claude-haiku-4.5',
      max_tokens: maxTokens,
      messages: [{ role: 'user', content: prompt }],
    }),
  });
  if (!r.ok) {
    const err = await r.text().catch(() => '');
    throw new Error(`OpenRouter API error ${r.status}: ${err}`);
  }
  const d = await r.json();
  return (d.choices && d.choices[0] && d.choices[0].message) ? d.choices[0].message.content.trim() : '';
}

// Unified AI call: routes to Claude or OpenRouter based on user preference
async function callAI(prompt, apiKeys, maxTokens = 1024) {
  if (apiKeys.aiProvider === 'openrouter' && apiKeys.openrouter) {
    return callOpenRouter(prompt, apiKeys.openrouter, maxTokens);
  }
  return callClaude(prompt, apiKeys.claude, maxTokens);
}

// Helper: check if AI is configured
function hasAiKey(apiKeys) {
  if (apiKeys.aiProvider === 'openrouter') return !!apiKeys.openrouter;
  return !!apiKeys.claude;
}

// AI: Generate insights
async function fetchAiInsights(stockInfo, apiKeys) {
  const prompt = `Analyze the stock ${stockInfo.name} (${stockInfo.ticker}).
Current Price: $${stockInfo.price || 'N/A'}
PE Ratio: ${stockInfo.pe || 'N/A'}
Market Cap: $${fmtBigNum(stockInfo.marketCap)}
EBITDA: $${fmtBigNum(stockInfo.ebitda)}
FCF: $${fmtBigNum(stockInfo.fcf)}

Provide your analysis in this EXACT JSON format (no markdown, no code fences, just raw JSON):
{
  "summary": "Three Word Summary",
  "sentiment": "Three Word Sentiment",
  "intro": "One sentence introduction about the company and its current position.",
  "pros": ["Pro point 1", "Pro point 2", "Pro point 3"],
  "cons": ["Con point 1", "Con point 2", "Con point 3"]
}`;
  const text = await callAI(prompt, apiKeys);
  const jsonMatch = text.match(/\{[\s\S]*\}/);
  return jsonMatch ? JSON.parse(jsonMatch[0]) : null;
}

// AI: Summarize news for price alert dates
async function fetchAiNewsSummary(newsItems, apiKeys) {
  if (!newsItems || newsItems.length === 0) return 'No news available for this date.';
  const headlines = newsItems.map(n => n.headline || n.title || '').filter(Boolean).slice(0, 5).join('\n- ');
  const prompt = `Given these news headlines for a stock on a day with >5% price change:
- ${headlines}

Write ONE concise sentence (max 30 words) summarizing what likely caused the price movement. Output ONLY the sentence, nothing else.`;
  try {
    return await callAI(prompt, apiKeys, 100);
  } catch {
    return 'AI summary unavailable.';
  }
}

// ============================================================
// SECTION 4: CALCULATION & UTILITY FUNCTIONS
// ============================================================
function fmtNum(n, dec = 2) {
  if (n == null || isNaN(n)) return '-';
  return Number(n).toLocaleString('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec });
}

function fmtBigNum(n) {
  if (n == null || isNaN(n)) return '-';
  const abs = Math.abs(n);
  if (abs >= 1e12) return (n / 1e12).toFixed(2) + 'T';
  if (abs >= 1e9) return (n / 1e9).toFixed(2) + 'B';
  if (abs >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (abs >= 1e3) return (n / 1e3).toFixed(2) + 'K';
  return fmtNum(n);
}

function fmtPct(n) {
  if (n == null || isNaN(n)) return '-';
  return (n >= 0 ? '+' : '') + (n * 100).toFixed(2) + '%';
}

function safePE(pe) {
  if (pe == null || isNaN(pe) || pe < 0) return 0;
  return Number(pe.toFixed(2));
}

function calcPE(price, eps) {
  if (!price || !eps || eps === 0) return null;
  const pe = price / eps;
  return pe < 0 ? 0 : Number(pe.toFixed(2));
}

function calcForwardPE(price, eps, egr) {
  if (!price || !eps || egr == null || eps === 0) return null;
  const fpe = price / (eps * (1 + egr / 100));
  return fpe < 0 ? 0 : Number(fpe.toFixed(2));
}

function calcMarketCap(price, shares) {
  if (!price || !shares) return null;
  return price * shares;
}

// Calculate daily % changes for price alert
function calcDailyChanges(prices) {
  if (!prices || prices.length < 2) return [];
  const sorted = [...prices].sort((a, b) => new Date(a.date) - new Date(b.date));
  const changes = [];
  for (let i = 1; i < sorted.length; i++) {
    const prev = sorted[i - 1].close;
    const curr = sorted[i].close;
    const pct = prev !== 0 ? (curr - prev) / prev : 0;
    changes.push({ date: sorted[i].date, close: curr, prevClose: prev, change: pct });
  }
  return changes;
}

// Find days with >5% change
function findSignificantChanges(changes, threshold = 0.05) {
  return changes.filter(c => Math.abs(c.change) > threshold);
}

// Calculate 15Y Market Cap / EBITDA ratio
function calcMktCapToEbitda(evData, incomeData) {
  const evByYear = {};
  (evData || []).forEach(e => {
    const y = e.date ? e.date.slice(0, 4) : null;
    if (y) evByYear[y] = e.marketCapitalization;
  });
  const result = [];
  (incomeData || []).forEach(i => {
    const y = i.calendarYear || i.fiscalYear || (i.date ? i.date.slice(0, 4) : null);
    if (!y) return;
    const mktCap = evByYear[y];
    const ebitda = i.ebitda;
    let ratio = null;
    if (mktCap && ebitda && ebitda > 0) {
      ratio = Number((mktCap / ebitda).toFixed(2));
    }
    result.push({ year: y, mktCap: mktCap || null, ebitda: ebitda || null, ratio });
  });
  return result.sort((a, b) => a.year.localeCompare(b.year));
}

// Build historical series by year from key-metrics
function buildYearSeries(data, field, yearField = 'calendarYear') {
  if (!data || !data.length) return [];
  return data
    .map(d => ({ year: String(d[yearField] || d.fiscalYear || (d.date ? d.date.slice(0, 4) : '')), value: d[field] }))
    .filter(d => d.year)
    .sort((a, b) => a.year.localeCompare(b.year));
}

// Parse distribution data from FMP stable API
function parseDistribution(raw) {
  if (!raw || !Array.isArray(raw) || raw.length === 0) return null;
  const latest = raw[0];
  if (typeof latest !== 'object') return null;
  // Stable API wraps segment data under a "data" key
  const source = latest.data && typeof latest.data === 'object' ? latest.data : latest;
  const skipKeys = new Set(['date', 'symbol', 'fiscalYear', 'period', 'reportedCurrency']);
  const entries = Object.entries(source).filter(([k]) => !skipKeys.has(k));
  if (entries.length === 0) return null;
  return entries.map(([label, value]) => ({ label, value: Number(value) || 0 })).filter(d => d.value > 0);
}

// Determine the expected year range for a company
function getExpectedYears(rawData) {
  const profile = rawData.profile;
  const allSeries = [
    ...(rawData.metrics || []),
    ...(rawData.ratios || []),
    ...(rawData.income || []),
    ...(rawData.ev || []),
    ...(rawData.cashflow || []),
  ];
  // Try IPO date from profile
  let ipoYear = null;
  if (profile && profile.ipoDate) {
    const y = parseInt(profile.ipoDate.slice(0, 4));
    if (!isNaN(y) && y > 1900) ipoYear = y;
  }
  // Find earliest year in any dataset
  let earliestData = CURRENT_YEAR;
  allSeries.forEach(d => {
    const y = parseInt(d.calendarYear || d.fiscalYear || (d.date ? d.date.slice(0, 4) : ''));
    if (!isNaN(y) && y > 1900 && y < earliestData) earliestData = y;
  });
  const startYear = ipoYear ? Math.min(ipoYear, earliestData) : earliestData;
  const maxSpan = CURRENT_YEAR - startYear;
  const expectedYears = Math.min(DATA_YEARS, Math.max(1, maxSpan));
  // Build the list of expected year strings
  const yearList = [];
  for (let i = 0; i < expectedYears; i++) {
    yearList.push(String(CURRENT_YEAR - expectedYears + 1 + i));
  }
  return { startYear, expectedYears, yearList };
}

// Build a history status with missingYears info
function buildHistoryStatus(series, yearList) {
  const dataMap = {};
  series.forEach(d => { dataMap[d.year] = d.value; });
  const missing = yearList.filter(y => dataMap[y] == null);
  return {
    available: yearList.length - missing.length,
    total: yearList.length,
    data: series,
    dataMap,
    missingYears: missing,
    yearList,
  };
}

// Build checklist status from fetched data
function buildChecklist(rawData) {
  const status = {};
  const metrics = rawData.metrics || [];
  const income = rawData.income || [];
  const ev = rawData.ev || [];
  const cashflow = rawData.cashflow || [];
  const profile = rawData.profile;
  const prices1y = rawData.prices1y || [];

  const { startYear, expectedYears, yearList } = getExpectedYears(rawData);
  status._meta = { startYear, expectedYears, yearList };

  const ratios = rawData.ratios || [];
  const peYears = buildYearSeries(ratios, 'priceToEarningsRatio');
  status.pe15 = buildHistoryStatus(peYears, yearList);

  const psYears = buildYearSeries(ratios, 'priceToSalesRatio');
  status.ps15 = buildHistoryStatus(psYears, yearList);

  const ebitdaYears = income.map(d => ({
    year: d.calendarYear || d.fiscalYear || (d.date ? d.date.slice(0, 4) : null), value: d.ebitda
  })).filter(d => d.year && d.value != null).sort((a, b) => a.year.localeCompare(b.year));
  status.ebitda15 = buildHistoryStatus(ebitdaYears, yearList);

  const mcYears = ev.map(d => ({
    year: d.date ? d.date.slice(0, 4) : null, value: d.marketCapitalization
  })).filter(d => d.year && d.value != null).sort((a, b) => a.year.localeCompare(b.year));
  status.mktcap15 = buildHistoryStatus(mcYears, yearList);

  const fcfYears = cashflow.map(d => ({
    year: d.calendarYear || d.fiscalYear || (d.date ? d.date.slice(0, 4) : null), value: d.freeCashFlow
  })).filter(d => d.year && d.value != null).sort((a, b) => a.year.localeCompare(b.year));
  status.fcf15 = buildHistoryStatus(fcfYears, yearList);

  status.price = { available: profile && profile.price ? 1 : 0, total: 1, data: profile ? profile.price : null };
  const eps = profile ? (profile.eps || null) : null;
  status.eps = { available: eps != null ? 1 : 0, total: 1, data: eps };
  const shares = profile ? (profile.sharesOutstanding || null) : null;
  status.shares = { available: shares != null ? 1 : 0, total: 1, data: shares };
  status.egr = { available: 0, total: 1, data: null };

  const geo = parseDistribution(rawData.geo);
  status.geo = { available: geo ? 1 : 0, total: 1, data: geo };

  const seg = parseDistribution(rawData.seg);
  status.seg = { available: seg ? 1 : 0, total: 1, data: seg };

  status.prices1y = { available: prices1y.length > 0 ? 1 : 0, total: 1, data: prices1y };

  // Significant days (>5% change)
  const dailyChanges = calcDailyChanges(prices1y);
  const sigDays = findSignificantChanges(dailyChanges);
  status.sig5 = { available: prices1y.length > 0 ? 1 : 0, total: 1, data: sigDays, count: sigDays.length };

  return status;
}

// ============================================================
// SECTION 5: REACT COMPONENTS
// ============================================================

// --- Spinner ---
function Spinner({ size }) {
  return <span className={`spinner ${size === 'lg' ? 'spinner-lg' : ''}`} />;
}

// --- Loading Overlay ---
function LoadingOverlay({ text }) {
  return (
    <div className="loading-overlay">
      <Spinner size="lg" />
      <span className="loading-text">{text || 'Loading...'}</span>
    </div>
  );
}

// --- Chart Wrapper (Chart.js) ---
// Chart.js global dark theme
Chart.defaults.color = '#94A3B8';
Chart.defaults.borderColor = '#252D3A';
Chart.defaults.plugins.tooltip.backgroundColor = '#1A2030';
Chart.defaults.plugins.tooltip.borderColor = '#252D3A';
Chart.defaults.plugins.tooltip.borderWidth = 1;
Chart.defaults.plugins.tooltip.titleColor = '#E2E8F0';
Chart.defaults.plugins.tooltip.bodyColor = '#94A3B8';
Chart.defaults.plugins.tooltip.titleFont = { family: "'JetBrains Mono', monospace", weight: '600', size: 12 };
Chart.defaults.plugins.tooltip.bodyFont = { family: "'JetBrains Mono', monospace", size: 11 };
Chart.defaults.plugins.tooltip.padding = 10;
Chart.defaults.plugins.tooltip.cornerRadius = 8;
Chart.defaults.plugins.legend.labels.font = { family: "'Inter', sans-serif", size: 12 };
Chart.defaults.scale.grid.color = 'rgba(37,45,58,0.6)';
Chart.defaults.scale.ticks.font = { family: "'JetBrains Mono', monospace", size: 10 };

function ChartWrap({ type, data, options, height }) {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  useEffect(() => {
    if (chartRef.current) chartRef.current.destroy();
    if (!canvasRef.current || !data) return;
    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type,
      data,
      options: { responsive: true, maintainAspectRatio: false, ...options },
    });
    return () => { if (chartRef.current) chartRef.current.destroy(); };
  }, [type, data, options]);
  return (
    <div className="chart-canvas-wrap" style={height ? { height } : {}}>
      <canvas ref={canvasRef} />
    </div>
  );
}

// --- Pie Chart Wrapper ---
function PieWrap({ data, options, height }) {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);
  useEffect(() => {
    if (chartRef.current) chartRef.current.destroy();
    if (!canvasRef.current || !data) return;
    const ctx = canvasRef.current.getContext('2d');
    chartRef.current = new Chart(ctx, {
      type: 'doughnut',
      data,
      options: { responsive: true, maintainAspectRatio: false, ...options },
    });
    return () => { if (chartRef.current) chartRef.current.destroy(); };
  }, [data, options]);
  return (
    <div className="pie-canvas-wrap" style={height ? { height } : {}}>
      <canvas ref={canvasRef} />
    </div>
  );
}

// ============================================================
// SECTION 6: API KEY MODAL
// ============================================================
function ApiKeyModal({ keys, onSave }) {
  const [fmp, setFmp] = useState(keys.fmp || '');
  const [claude, setClaude] = useState(keys.claude || '');
  const [openrouter, setOpenrouter] = useState(keys.openrouter || '');
  const [aiProvider, setAiProvider] = useState(keys.aiProvider || 'claude');
  const [finnhub, setFinnhub] = useState(keys.finnhub || '');
  const aiKeyValid = aiProvider === 'claude' ? !!claude : !!openrouter;
  return (
    <div className="modal-overlay">
      <div className="modal modal-sm">
        <div className="modal-header">
          <h2>API Keys Setup</h2>
          <p>Enter your API keys to use the application. Keys are stored locally in your browser.</p>
        </div>
        <div className="modal-body">
          <div className="input-group mb-4">
            <label className="input-label">Financial Modeling Prep (FMP) API Key *</label>
            <input className="input" value={fmp} onChange={e => setFmp(e.target.value)} placeholder="Your FMP API key" />
          </div>
          <div className="input-group mb-4">
            <label className="input-label">AI Provider *</label>
            <div style={{ display: 'flex', gap: '8px' }}>
              <button
                className={`btn ${aiProvider === 'claude' ? 'btn-primary' : 'btn-outline'}`}
                style={{ flex: 1 }}
                onClick={() => setAiProvider('claude')}
              >
                Anthropic Claude
              </button>
              <button
                className={`btn ${aiProvider === 'openrouter' ? 'btn-primary' : 'btn-outline'}`}
                style={{ flex: 1 }}
                onClick={() => setAiProvider('openrouter')}
              >
                OpenRouter
              </button>
            </div>
          </div>
          {aiProvider === 'claude' && (
            <div className="input-group mb-4">
              <label className="input-label">Anthropic Claude API Key *</label>
              <input className="input" value={claude} onChange={e => setClaude(e.target.value)} placeholder="sk-ant-..." type="password" />
            </div>
          )}
          {aiProvider === 'openrouter' && (
            <div className="input-group mb-4">
              <label className="input-label">OpenRouter API Key *</label>
              <input className="input" value={openrouter} onChange={e => setOpenrouter(e.target.value)} placeholder="sk-or-..." type="password" />
              <span style={{ fontSize: '11px', color: 'var(--text-dim)', marginTop: '4px' }}>
                Get your key at openrouter.ai — uses Claude Haiku via OpenRouter
              </span>
            </div>
          )}
          <div className="input-group">
            <label className="input-label">Finnhub API Key (optional, for targeted news)</label>
            <input className="input" value={finnhub} onChange={e => setFinnhub(e.target.value)} placeholder="Finnhub API key (optional)" />
          </div>
        </div>
        <div className="modal-footer">
          <button className="btn btn-primary" disabled={!fmp || !aiKeyValid} onClick={() => onSave({ fmp, claude, openrouter, finnhub, aiProvider })}>
            Save & Continue
          </button>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// SECTION 7: SMART SEARCH
// ============================================================
function SmartSearch({ apiKey, onSelect }) {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  const [loading, setLoading] = useState(false);
  const [showResults, setShowResults] = useState(false);
  const [searchError, setSearchError] = useState(false);
  const timerRef = useRef(null);
  const wrapRef = useRef(null);

  useEffect(() => {
    function handleClick(e) {
      if (wrapRef.current && !wrapRef.current.contains(e.target)) setShowResults(false);
    }
    document.addEventListener('mousedown', handleClick);
    return () => document.removeEventListener('mousedown', handleClick);
  }, []);

  const doSearch = useCallback(async (q) => {
    if (!q || q.length < 1) { setResults([]); setSearchError(false); return; }
    setLoading(true);
    try {
      const r = await searchTickers(q, apiKey);
      setResults(r || []);
      setShowResults(true);
      setSearchError(false);
    } catch {
      setResults([]);
      setSearchError(true);
    }
    setLoading(false);
  }, [apiKey]);

  function handleInput(e) {
    const v = e.target.value;
    setQuery(v);
    clearTimeout(timerRef.current);
    timerRef.current = setTimeout(() => doSearch(v), 400);
  }

  function handleDirectSubmit() {
    const ticker = query.trim().toUpperCase();
    if (!ticker) return;
    setShowResults(false);
    setQuery('');
    setResults([]);
    setSearchError(false);
    onSelect({ ticker, name: ticker, exchange: '' });
  }

  function handleKeyDown(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(timerRef.current);
      if (results.length > 0 && showResults) {
        // Select the first search result
        const item = results[0];
        setShowResults(false);
        setQuery('');
        setResults([]);
        onSelect({ ticker: item.symbol, name: item.name, exchange: item.exchangeShortName });
      } else {
        // Direct ticker input
        handleDirectSubmit();
      }
    }
  }

  function handleSelect(item) {
    setShowResults(false);
    setQuery('');
    setResults([]);
    onSelect({ ticker: item.symbol, name: item.name, exchange: item.exchangeShortName });
  }

  return (
    <div className="search-wrap" ref={wrapRef}>
      <span className="search-icon">&#128269;</span>
      <input
        className="input search-input"
        placeholder="Enter ticker symbol and press Enter (e.g., AAPL, NVDA, MSFT)..."
        value={query}
        onChange={handleInput}
        onKeyDown={handleKeyDown}
        onFocus={() => results.length > 0 && setShowResults(true)}
      />
      {loading && <span className="search-spinner"><Spinner /></span>}
      {showResults && results.length > 0 && (
        <div className="search-results">
          {results.map(r => (
            <div key={r.symbol} className="search-item" onClick={() => handleSelect(r)}>
              <span className="search-item-ticker">{r.symbol}</span>
              <span className="search-item-name">{r.name}</span>
            </div>
          ))}
        </div>
      )}
      {searchError && query.trim() && !showResults && (
        <div style={{fontSize:'13px',color:'var(--text-sec)',marginTop:'4px'}}>
          Search API unavailable. Type the ticker symbol directly and press Enter.
        </div>
      )}
    </div>
  );
}

// ============================================================
// SECTION 8: DATA CHECKLIST MODAL (with full manual input)
// ============================================================
function DataChecklistModal({ checklist, onConfirm, onCancel, initialInputs, cancelLabel, onAutoSave }) {
  // userInputs shape: { price: '185', eps: '6.42', pe15: { '2015': '22', ... }, geo: [{label,value}], ... }
  const [userInputs, setUserInputs] = useState(initialInputs || {});
  // Distribution rows for geo/seg manual entry
  const [geoRows, setGeoRows] = useState(initialInputs?.geo || checklist.geo?.data || []);
  const [segRows, setSegRows] = useState(initialInputs?.seg || checklist.seg?.data || []);

  const meta = checklist._meta || {};

  // Auto-save user inputs on every change
  useEffect(() => {
    if (!onAutoSave) return;
    const snapshot = { ...userInputs };
    const validGeo = geoRows.filter(r => r.label && r.value).map(r => ({ label: r.label, value: Number(r.value) || 0 }));
    const validSeg = segRows.filter(r => r.label && r.value).map(r => ({ label: r.label, value: Number(r.value) || 0 }));
    if (validGeo.length > 0) snapshot.geo = validGeo;
    if (validSeg.length > 0) snapshot.seg = validSeg;
    onAutoSave(snapshot);
  }, [userInputs, geoRows, segRows]);

  function handleSingleChange(key, value) {
    if (value !== '' && isNaN(Number(value))) return;
    setUserInputs(prev => ({ ...prev, [key]: value }));
  }

  function handleYearChange(metricKey, year, value) {
    if (value !== '' && isNaN(Number(value))) return;
    setUserInputs(prev => {
      const obj = { ...(prev[metricKey] || {}) };
      obj[year] = value;
      return { ...prev, [metricKey]: obj };
    });
  }

  function addDistRow(type) {
    const setter = type === 'geo' ? setGeoRows : setSegRows;
    setter(prev => [...prev, { label: '', value: '' }]);
  }

  function updateDistRow(type, idx, field, val) {
    if (field === 'value' && val !== '' && isNaN(Number(val))) return;
    const setter = type === 'geo' ? setGeoRows : setSegRows;
    setter(prev => prev.map((r, i) => i === idx ? { ...r, [field]: val } : r));
  }

  function removeDistRow(type, idx) {
    const setter = type === 'geo' ? setGeoRows : setSegRows;
    setter(prev => prev.filter((_, i) => i !== idx));
  }

  function handleConfirm() {
    const result = { ...userInputs };
    // Package distribution data (user enters in billions, multiply by 1e9)
    const validGeo = geoRows.filter(r => r.label && r.value).map(r => ({ label: r.label, value: (Number(r.value) || 0) * 1e9 }));
    const validSeg = segRows.filter(r => r.label && r.value).map(r => ({ label: r.label, value: (Number(r.value) || 0) * 1e9 }));
    if (validGeo.length > 0) result.geo = validGeo;
    if (validSeg.length > 0) result.seg = validSeg;
    onConfirm(result);
  }

  function renderHistoryItem(item) {
    const status = checklist[item.key];
    if (!status) return null;
    const yearList = status.yearList || meta.yearList || [];
    const dataMap = status.dataMap || {};
    const isFull = status.available >= status.total;
    const isPartial = status.available > 0 && status.available < status.total;
    const hasMissing = status.missingYears && status.missingYears.length > 0;
    const showGrid = hasMissing || item.fmt === 'big';
    return (
      <div key={item.key} className="checklist-item">
        <div className="checklist-item-header">
          <span className={isFull ? 'checklist-ok' : isPartial ? 'checklist-warn' : 'checklist-miss'}>
            {isFull ? '\u2713' : isPartial ? '\u26A0' : '\u2717'}
          </span>
          <span className="checklist-label">{item.label}</span>
          <span className="checklist-detail">
            {status.available} of {status.total} years (since {yearList[0] || '?'})
          </span>
        </div>
        {showGrid && (
          <div className="checklist-input-grid">
            {yearList.map(year => {
              const apiVal = dataMap[year];
              const hasApi = apiVal != null;
              return (
                <div key={year} className="checklist-year-cell">
                  <span>{year}</span>
                  {hasApi ? (
                    <input className="input input-sm has-api-val" value={item.fmt === 'big' ? '$' + fmtBigNum(apiVal) : fmtNum(apiVal, 2)} disabled title={`${apiVal}`} />
                  ) : (
                    <input
                      className="input input-sm"
                      placeholder={item.fmt === 'big' ? 'B' : '-'}
                      type="number"
                      step="any"
                      value={(userInputs[item.key] && userInputs[item.key][year]) || ''}
                      onChange={e => handleYearChange(item.key, year, e.target.value)}
                      title={item.fmt === 'big' ? 'Enter value in billions (e.g. 2.5 = $2.5B)' : ''}
                    />
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    );
  }

  function renderSingleItem(item) {
    const status = checklist[item.key];
    if (!status) return null;
    const hasData = status.available > 0;
    return (
      <div key={item.key} className="checklist-item">
        <div className="checklist-item-header">
          <span className={hasData ? 'checklist-ok' : 'checklist-miss'}>
            {hasData ? '\u2713' : '\u2717'}
          </span>
          <span className="checklist-label">{item.label}</span>
          {hasData ? (
            <span className="checklist-detail">Available: {typeof status.data === 'number' ? (item.fmt === 'big' ? fmtBigNum(status.data) : fmtNum(status.data)) : status.data}</span>
          ) : (
            <input
              className="input input-sm"
              style={{ width: 140 }}
              placeholder={item.fmt === 'big' ? 'In billions' : 'Enter value'}
              type="number"
              step="any"
              value={userInputs[item.key] || ''}
              onChange={e => handleSingleChange(item.key, e.target.value)}
              title={item.fmt === 'big' ? 'Enter value in billions (e.g. 2.5 = 2.5B)' : ''}
            />
          )}
        </div>
      </div>
    );
  }

  function renderDistItem(item) {
    const status = checklist[item.key];
    if (!status) return null;
    const hasData = status.available > 0;
    const isGeo = item.key === 'geo';
    const rows = isGeo ? geoRows : segRows;
    return (
      <div key={item.key} className="checklist-item">
        <div className="checklist-item-header">
          <span className={hasData ? 'checklist-ok' : 'checklist-miss'}>
            {hasData ? '\u2713' : '\u2717'}
          </span>
          <span className="checklist-label">{item.label}</span>
          <span className="checklist-detail">{hasData ? `${(status.data || []).length} segments` : 'Missing (paid API) - enter manually'}</span>
        </div>
        <div className="checklist-dist-rows">
          {rows.map((row, idx) => (
            <div key={idx} className="checklist-dist-row">
              <input
                className="input input-sm"
                placeholder={isGeo ? 'Region name' : 'Segment name'}
                value={row.label || ''}
                onChange={e => updateDistRow(item.key, idx, 'label', e.target.value)}
              />
              <input
                className="input input-sm"
                placeholder="Revenue (in B)"
                type="number"
                step="any"
                value={row.value || ''}
                onChange={e => updateDistRow(item.key, idx, 'value', e.target.value)}
              />
              <button className="btn btn-sm btn-outline" onClick={() => removeDistRow(item.key, idx)} title="Remove">&times;</button>
            </div>
          ))}
          <button className="btn btn-sm btn-outline" onClick={() => addDistRow(item.key)}>+ Add {isGeo ? 'Region' : 'Segment'}</button>
        </div>
      </div>
    );
  }

  function renderPriceSeriesItem(item) {
    const status = checklist[item.key];
    if (!status) return null;
    const hasData = status.available > 0;
    return (
      <div key={item.key} className="checklist-item">
        <div className="checklist-item-header">
          <span className={hasData ? 'checklist-ok' : 'checklist-miss'}>
            {hasData ? '\u2713' : '\u2717'}
          </span>
          <span className="checklist-label">{item.label}</span>
          <span className="checklist-detail">
            {hasData ? `${(status.data || []).length} days` : 'Missing (required for price alerts)'}
          </span>
        </div>
      </div>
    );
  }

  function renderReadonlyItem(item) {
    const status = checklist[item.key];
    if (!status) return null;
    const hasData = status.available > 0;
    let detail = 'No data';
    if (item.key === 'sig5') {
      detail = hasData ? `${status.count} day${status.count !== 1 ? 's' : ''} with >5% change found` : 'No price data';
    }
    return (
      <div key={item.key} className="checklist-item">
        <div className="checklist-item-header">
          <span className={hasData ? 'checklist-ok' : 'checklist-miss'}>
            {hasData ? '\u2713' : '\u2717'}
          </span>
          <span className="checklist-label">{item.label}</span>
          <span className="checklist-detail">{detail}</span>
        </div>
      </div>
    );
  }

  return (
    <div className="modal-overlay">
      <div className="modal modal-lg">
        <div className="modal-header">
          <h2>Data Review Checklist</h2>
          <p>
            Data range: {meta.expectedYears || '?'} years (since {meta.yearList?.[0] || '?'}).
            Fill in missing values below or leave blank to skip.
          </p>
          <p style={{ fontSize: 12, color: 'var(--accent)', marginTop: 4 }}>
            Note: For EBITDA, Market Cap, FCF, and Shares fields, enter values in billions (e.g. 2.5 = $2.5B)
          </p>
        </div>
        <div className="modal-body">
          <div className="checklist">
            {CHECKLIST_ITEMS.map(item => {
              if (item.type === 'history') return renderHistoryItem(item);
              if (item.type === 'single') return renderSingleItem(item);
              if (item.type === 'distribution') return renderDistItem(item);
              if (item.type === 'priceSeries') return renderPriceSeriesItem(item);
              if (item.type === 'readonly') return renderReadonlyItem(item);
              return null;
            })}
          </div>
        </div>
        <div className="modal-footer">
          <button className="btn btn-outline" onClick={onCancel}>{cancelLabel || 'Back to Dashboard'}</button>
          <button className="btn btn-primary" onClick={handleConfirm}>Confirm & View Details</button>
        </div>
      </div>
    </div>
  );
}

// ============================================================
// SECTION 9: METRICS TABLE (2xN Grid with editable fields)
// ============================================================
function MetricsTable({ data, overrides, onOverrideChange }) {
  const price = overrides.price != null ? Number(overrides.price) : data.price;
  const eps = overrides.eps != null ? Number(overrides.eps) : data.eps;
  const egr = overrides.egr != null ? Number(overrides.egr) : (data.egr || null);
  const ebitda = overrides.ebitda != null ? Number(overrides.ebitda) : data.ebitda;
  const fcf = overrides.fcf != null ? Number(overrides.fcf) : data.fcf;
  const shares = data.shares;

  const pe = calcPE(price, eps);
  const forwardPE = calcForwardPE(price, eps, egr);
  const marketCap = calcMarketCap(price, shares);

  const fields = [
    { key: 'price', label: 'Price', value: price, fmt: v => '$' + fmtNum(v), editable: true, calc: null },
    { key: 'pe', label: 'PE Ratio', value: pe, fmt: v => fmtNum(v), editable: false, calc: 'Price / EPS' },
    { key: 'ps', label: 'PS Ratio', value: data.ps, fmt: v => fmtNum(v), editable: false, calc: null },
    { key: 'ebitda', label: 'EBITDA', value: ebitda, fmt: v => '$' + fmtBigNum(v), editable: false, calc: null },
    { key: 'fcf', label: 'Free Cash Flow', value: fcf, fmt: v => '$' + fmtBigNum(v), editable: false, calc: null },
    { key: 'mktcap', label: 'Market Cap', value: marketCap, fmt: v => '$' + fmtBigNum(v), editable: false, calc: 'Price \u00D7 Shares' },
    { key: 'eps', label: 'EPS (TTM)', value: eps, fmt: v => '$' + fmtNum(v), editable: true, calc: null },
    { key: 'egr', label: 'Exp. Growth Rate (%)', value: egr, fmt: v => fmtNum(v) + '%', editable: true, calc: null },
    { key: 'forwardPE', label: 'Forward PE', value: forwardPE, fmt: v => fmtNum(v), editable: false, calc: 'Price / (EPS\u00D7(1+EGR))' },
    { key: 'shares', label: 'Shares Outstanding', value: shares, fmt: v => fmtBigNum(v), editable: false, calc: null },
  ];

  function handleChange(key, val) {
    if (val === '') { onOverrideChange(key, null); return; }
    const num = Number(val);
    if (isNaN(num)) return;
    onOverrideChange(key, num);
  }

  return (
    <div className="metrics-grid">
      {fields.map(f => (
        <div key={f.key} className="metric-card">
          <div className="metric-label">{f.label}</div>
          {f.editable ? (
            <input
              className="metric-input"
              type="number"
              step="any"
              value={overrides[f.key] != null ? overrides[f.key] : (f.value != null ? f.value : '')}
              placeholder="-"
              onChange={e => handleChange(f.key, e.target.value)}
            />
          ) : (
            <div className="metric-value">{f.value != null ? f.fmt(f.value) : '-'}</div>
          )}
          {f.calc && <div className="metric-calc">= {f.calc}</div>}
        </div>
      ))}
    </div>
  );
}

// ============================================================
// SECTION 10: AI INSIGHTS PANEL
// ============================================================
function AiInsightsPanel({ insights, loading, error }) {
  if (loading) return (
    <div className="ai-panel">
      <h3>AI Insights</h3>
      <div className="ai-loading"><Spinner /> Generating AI analysis...</div>
    </div>
  );
  if (error) return (
    <div className="ai-panel">
      <h3>AI Insights</h3>
      <div className="ai-loading" style={{ color: 'var(--danger)' }}>Error: {error}</div>
    </div>
  );
  if (!insights) return null;
  return (
    <div className="ai-panel">
      <h3>AI Insights</h3>
      <div className="ai-tags">
        <span className="ai-tag ai-tag-blue">{insights.summary || '...'}</span>
        <span className="ai-tag ai-tag-amber">{insights.sentiment || '...'}</span>
      </div>
      <p className="ai-intro">{insights.intro || ''}</p>
      <div className="ai-bullets">
        {(insights.pros || []).map((p, i) => (
          <div key={'pro' + i} className="ai-bullet ai-pro">{'\u2705'} {p}</div>
        ))}
        {(insights.cons || []).map((c, i) => (
          <div key={'con' + i} className="ai-bullet ai-con">{'\u274C'} {c}</div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// SECTION 11: HISTORICAL LINE CHART (reusable)
// ============================================================
function HistoryChart({ title, series, yLabel, color, formatFn }) {
  if (!series || series.length === 0) {
    return (
      <div className="chart-card">
        <h4>{title}</h4>
        <div className="chart-empty">No data available</div>
      </div>
    );
  }
  const data = {
    labels: series.map(s => s.year),
    datasets: [{
      label: yLabel || title,
      data: series.map(s => s.value),
      borderColor: color || CHART_COLORS[0],
      backgroundColor: (color || CHART_COLORS[0]) + '20',
      fill: true,
      tension: 0.3,
      pointRadius: 3,
      pointHoverRadius: 5,
    }],
  };
  const options = {
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: ctx => formatFn ? formatFn(ctx.raw) : fmtNum(ctx.raw),
        },
      },
    },
    scales: {
      x: { grid: { display: false } },
      y: {
        ticks: { callback: v => formatFn ? formatFn(v) : fmtNum(v, 0) },
      },
    },
  };
  return (
    <div className="chart-card">
      <h4>{title}</h4>
      <ChartWrap type="line" data={data} options={options} />
    </div>
  );
}

// ============================================================
// SECTION 12: PRICE ALERT CHART
// ============================================================
function PriceAlertChart({ prices1y, significantDays }) {
  if (!prices1y || prices1y.length === 0) {
    return (
      <div className="chart-card">
        <h4>1Y Price Trend & Alerts (&gt;5% Change)</h4>
        <div className="chart-empty">No price data available</div>
      </div>
    );
  }
  const sorted = [...prices1y].sort((a, b) => new Date(a.date) - new Date(b.date));
  const sigSet = new Set((significantDays || []).map(s => s.date));

  const data = {
    labels: sorted.map(p => p.date),
    datasets: [{
      label: 'Close Price',
      data: sorted.map(p => p.close),
      borderColor: '#4ADE80',
      backgroundColor: 'rgba(74,222,128,0.08)',
      fill: true,
      tension: 0.2,
      pointRadius: sorted.map(p => sigSet.has(p.date) ? 4 : 0),
      pointBackgroundColor: sorted.map(p => sigSet.has(p.date) ? '#F87171' : 'transparent'),
      pointBorderColor: sorted.map(p => sigSet.has(p.date) ? '#F87171' : 'transparent'),
      pointHoverRadius: sorted.map(p => sigSet.has(p.date) ? 6 : 4),
    }],
  };
  const options = {
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: ctx => {
            const d = sorted[ctx.dataIndex];
            const sig = significantDays.find(s => s.date === d.date);
            let lbl = `$${fmtNum(ctx.raw)}`;
            if (sig) lbl += ` (${fmtPct(sig.change)})`;
            return lbl;
          },
        },
      },
    },
    scales: {
      x: {
        grid: { display: false },
        ticks: { maxTicksLimit: 12, callback: function(val) {
          const lbl = this.getLabelForValue(val);
          return lbl ? lbl.slice(5) : '';
        }},
      },
      y: { ticks: { callback: v => '$' + fmtNum(v, 0) } },
    },
  };
  return (
    <div className="chart-card">
      <h4>1Y Price Trend & Alerts (&gt;5% Change)</h4>
      <ChartWrap type="line" data={data} options={options} />
    </div>
  );
}

// ============================================================
// SECTION 13: PRICE ALERT LIST
// ============================================================
function PriceAlertList({ alerts, loading }) {
  if (loading) {
    return (
      <div className="alert-section">
        <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>Price Alerts (&gt;5% Daily Change)</h3>
        <div className="text-center text-sec"><Spinner /> Fetching news for alert dates...</div>
      </div>
    );
  }
  if (!alerts || alerts.length === 0) {
    return (
      <div className="alert-section">
        <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>Price Alerts (&gt;5% Daily Change)</h3>
        <p className="text-sec" style={{ fontSize: 13 }}>No days with &gt;5% price change in the last year.</p>
      </div>
    );
  }
  return (
    <div className="alert-section">
      <h3 style={{ fontSize: 16, fontWeight: 600, marginBottom: 8 }}>Price Alerts (&gt;5% Daily Change)</h3>
      <div className="alert-list">
        <div className="alert-row" style={{ fontWeight: 600, background: 'var(--bg)' }}>
          <span>Date</span><span style={{ textAlign: 'center' }}>Change</span><span>News Summary</span>
        </div>
        {alerts.map((a, i) => (
          <div key={i} className="alert-row">
            <span className="alert-date">{a.date}</span>
            <span className={`alert-change ${a.change >= 0 ? 'alert-up' : 'alert-down'}`}>
              {fmtPct(a.change)}
            </span>
            <span className="alert-news">{a.newsSummary || 'No news available'}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// SECTION 14: DISTRIBUTION (PIE CHARTS)
// ============================================================
function DistributionSection({ geo, seg }) {
  function makePieData(items) {
    if (!items || items.length === 0) return null;
    return {
      labels: items.map(d => d.label),
      datasets: [{
        data: items.map(d => d.value),
        backgroundColor: PIE_COLORS.slice(0, items.length),
        borderWidth: 2,
        borderColor: '#151921',
      }],
    };
  }
  const geoData = makePieData(geo);
  const segData = makePieData(seg);
  const pieOptions = {
    plugins: {
      legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11 } } },
      tooltip: {
        callbacks: { label: ctx => `${ctx.label}: $${fmtBigNum(ctx.raw)}` },
      },
    },
  };
  return (
    <div className="pie-grid">
      <div className="pie-card">
        <h4>Revenue by Geographic Region</h4>
        {geoData ? <PieWrap data={geoData} options={pieOptions} /> : <div className="chart-empty">No geographic data available</div>}
      </div>
      <div className="pie-card">
        <h4>Revenue by Business Segment</h4>
        {segData ? <PieWrap data={segData} options={pieOptions} /> : <div className="chart-empty">No segment data available</div>}
      </div>
    </div>
  );
}

// ============================================================
// SECTION 15: MISSING DATA FOOTER
// ============================================================
function MissingDataFooter({ checklist }) {
  const missing = [];
  CHECKLIST_ITEMS.forEach(item => {
    const s = checklist[item.key];
    if (!s) return;
    if (item.type === 'history') {
      if (s.available === 0) missing.push(`The ${item.label} is entirely missing.`);
      else if (s.available < s.total) missing.push(`The ${item.label} is partially missing (${s.available}/${s.total} years).`);
    } else {
      if (s.available === 0) missing.push(`${item.label} is missing.`);
    }
  });
  if (missing.length === 0) return null;
  return (
    <div className="detail-footer">
      <h4>Missing Data Summary</h4>
      <ul>
        {missing.map((m, i) => <li key={i}>{m}</li>)}
      </ul>
    </div>
  );
}

// ============================================================
// SECTION 16: SUPPLEMENT CHARTS SECTION
// ============================================================
function SupplementSection({ mktCapEbitda }) {
  const [open, setOpen] = useState(false);
  return (
    <div className="supplement">
      <button className="supplement-toggle" onClick={() => setOpen(!open)}>
        <span>{open ? '\u25BC' : '\u25B6'}</span>
        <span>Supplemental Charts</span>
      </button>
      {open && (
        <div className="supplement-body">
          <div className="charts-grid">
            <HistoryChart
              title="15Y Market Cap / EBITDA Ratio"
              series={(mktCapEbitda || []).map(d => ({ year: d.year, value: d.ratio }))}
              yLabel="MktCap/EBITDA"
              color="#7c3aed"
              formatFn={v => v != null ? fmtNum(v, 1) + 'x' : '-'}
            />
          </div>
        </div>
      )}
    </div>
  );
}

// ============================================================
// SECTION 17: DASHBOARD PAGE
// ============================================================
function DashboardPage({ apiKeys, watchlist, setWatchlist, onSelectStock, onOpenKeys, proMode, setProMode }) {
  function handleSelect(stock) {
    if (watchlist.some(w => w.ticker === stock.ticker)) return;
    const newList = [...watchlist, stock];
    setWatchlist(newList);
  }
  function handleRemove(e, ticker) {
    e.stopPropagation();
    const newList = watchlist.filter(w => w.ticker !== ticker);
    setWatchlist(newList);
  }
  return (
    <div className="app">
      <header className="header">
        <div className="container header-inner">
          <span className="header-title">Stock Analyzer</span>
          <div className="header-actions">
            <button className="btn btn-outline btn-sm" onClick={onOpenKeys}>API Keys</button>
          </div>
        </div>
      </header>
      <main className="main">
        <div className="container">
          <SmartSearch apiKey={apiKeys.fmp} onSelect={handleSelect} />
          <label style={{ display: 'flex', alignItems: 'center', gap: 8, margin: '12px 0', cursor: 'pointer', fontSize: 14, color: 'var(--text-sec)' }}>
            <input type="checkbox" checked={proMode} onChange={e => setProMode(e.target.checked)} style={{ width: 18, height: 18, cursor: 'pointer' }} />
            Are you a pro?
            <span style={{ fontSize: 12, opacity: 0.7 }}>(enables manual data review before analysis)</span>
          </label>
          {watchlist.length === 0 ? (
            <div className="watchlist-empty">
              <div style={{ fontSize: 40, opacity: 0.3 }}>&#128200;</div>
              <p>Your watchlist is empty. Search for a stock to get started.</p>
            </div>
          ) : (
            <div className="watchlist">
              {watchlist.map(w => (
                <div key={w.ticker} className="wl-item" onClick={() => onSelectStock(w)}>
                  <div className="wl-item-left">
                    <span className="wl-item-ticker">{w.ticker}</span>
                    <span className="wl-item-name">{w.name}</span>
                  </div>
                  <div className="wl-item-right">
                    <span className="text-sec" style={{ fontSize: 12 }}>{w.exchange || ''}</span>
                    <button className="btn btn-danger btn-sm" onClick={e => handleRemove(e, w.ticker)}>Remove</button>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </main>
    </div>
  );
}

// ============================================================
// SECTION 18: DETAIL PAGE
// ============================================================
function DetailPage({ stock, apiKeys, rawData, checklist, userInputs, onBack, onBackToChecklist }) {
  const [overrides, setOv] = useState(() => {
    const saved = getOverrides(stock.ticker);
    return { ...saved };
  });
  const [aiInsights, setAiInsights] = useState(null);
  const [aiLoading, setAiLoading] = useState(false);
  const [aiError, setAiError] = useState(null);
  const [alerts, setAlerts] = useState([]);
  const [alertsLoading, setAlertsLoading] = useState(false);

  const profile = rawData.profile || {};
  const prices1y = rawData.prices1y || [];

  // Merge user inputs from checklist modal
  useEffect(() => {
    if (userInputs) {
      const merged = { ...overrides };
      if (userInputs.price) merged.price = Number(userInputs.price);
      if (userInputs.eps) merged.eps = Number(userInputs.eps);
      if (userInputs.shares) merged.shares = Number(userInputs.shares) * 1e9;
      if (userInputs.egr) merged.egr = Number(userInputs.egr);
      setOv(merged);
      setOverrides(stock.ticker, merged);
    }
  }, [userInputs]);

  // Helper: merge user-inputted year values into an existing series
  function mergeHistoryInputs(series, inputKey, transformFn) {
    const yearInputs = userInputs ? userInputs[inputKey] : null;
    if (!yearInputs || typeof yearInputs !== 'object') return series;
    const dataMap = {};
    series.forEach(d => { dataMap[d.year] = d.value; });
    Object.entries(yearInputs).forEach(([year, val]) => {
      if (val !== '' && val != null) {
        const num = Number(val);
        if (!isNaN(num)) dataMap[year] = transformFn ? transformFn(num) : num;
      }
    });
    return Object.entries(dataMap)
      .map(([year, value]) => ({ year, value }))
      .sort((a, b) => a.year.localeCompare(b.year));
  }

  // Base data for metrics
  const metricsData = useMemo(() => ({
    price: profile.price || null,
    eps: profile.eps || null,
    egr: null,
    ps: checklist.ps15?.data?.length > 0 ? checklist.ps15.data[checklist.ps15.data.length - 1].value : null,
    ebitda: checklist.ebitda15?.data?.length > 0 ? checklist.ebitda15.data[checklist.ebitda15.data.length - 1].value : null,
    fcf: checklist.fcf15?.data?.length > 0 ? checklist.fcf15.data[checklist.fcf15.data.length - 1].value : null,
    shares: profile.sharesOutstanding || null,
  }), [profile, checklist]);

  // Save overrides to localStorage when they change
  useEffect(() => {
    setOverrides(stock.ticker, overrides);
  }, [overrides, stock.ticker]);

  function handleOverrideChange(key, value) {
    setOv(prev => {
      const next = { ...prev, [key]: value };
      return next;
    });
  }

  // MktCap/EBITDA ratio
  const mktCapEbitda = useMemo(() => calcMktCapToEbitda(rawData.ev, rawData.income), [rawData]);

  // PE series - merge user inputs, apply negative PE = 0 rule
  const peSeries = useMemo(() => {
    const base = (checklist.pe15?.data || []).map(d => ({ year: d.year, value: safePE(d.value) }));
    return mergeHistoryInputs(base, 'pe15', v => safePE(v));
  }, [checklist, userInputs]);

  // PS series
  const psSeries = useMemo(() => {
    return mergeHistoryInputs(checklist.ps15?.data || [], 'ps15');
  }, [checklist, userInputs]);

  // EBITDA series
  const ebitdaSeries = useMemo(() => {
    return mergeHistoryInputs(checklist.ebitda15?.data || [], 'ebitda15', v => v * 1e9);
  }, [checklist, userInputs]);

  // Market Cap series
  const mktcapSeries = useMemo(() => {
    return mergeHistoryInputs(checklist.mktcap15?.data || [], 'mktcap15', v => v * 1e9);
  }, [checklist, userInputs]);

  // FCF series
  const fcfSeries = useMemo(() => {
    return mergeHistoryInputs(checklist.fcf15?.data || [], 'fcf15', v => v * 1e9);
  }, [checklist, userInputs]);

  // Price alert: calculate significant days
  const dailyChanges = useMemo(() => calcDailyChanges(prices1y), [prices1y]);
  const significantDays = useMemo(() => findSignificantChanges(dailyChanges), [dailyChanges]);

  // Fetch AI insights after mount
  useEffect(() => {
    if (!hasAiKey(apiKeys)) return;
    const price = overrides.price ?? metricsData.price;
    const eps = overrides.eps ?? metricsData.eps;
    setAiLoading(true);
    fetchAiInsights({
      name: stock.name,
      ticker: stock.ticker,
      price,
      pe: calcPE(price, eps),
      marketCap: calcMarketCap(price, metricsData.shares),
      ebitda: metricsData.ebitda,
      fcf: metricsData.fcf,
    }, apiKeys)
      .then(d => { setAiInsights(d); setAiError(null); })
      .catch(e => setAiError(e.message))
      .finally(() => setAiLoading(false));
  }, []);

  // Fetch news for significant days
  useEffect(() => {
    if (significantDays.length === 0) return;
    setAlertsLoading(true);
    const fetchNews = async () => {
      const results = [];
      for (const day of significantDays) {
        let news = [];
        try {
          if (apiKeys.finnhub) {
            news = await fetchFinnhubNews(stock.ticker, day.date, apiKeys.finnhub);
          } else {
            const allNews = await fetchFmpNews(stock.ticker, apiKeys.fmp, 100);
            news = (allNews || []).filter(n => {
              const nd = n.publishedDate ? n.publishedDate.slice(0, 10) : '';
              return nd === day.date;
            });
          }
        } catch {}
        let newsSummary = '';
        if (hasAiKey(apiKeys) && news.length > 0) {
          try {
            newsSummary = await fetchAiNewsSummary(news, apiKeys);
          } catch { newsSummary = news[0]?.headline || news[0]?.title || 'News found but summary unavailable.'; }
        } else if (news.length > 0) {
          newsSummary = news[0]?.headline || news[0]?.title || '';
        }
        results.push({ ...day, newsSummary });
      }
      setAlerts(results);
      setAlertsLoading(false);
    };
    fetchNews();
  }, [significantDays]);

  // Distribution data: prefer API, fall back to user inputs from checklist
  const geo = checklist.geo?.data || (userInputs?.geo?.length > 0 ? userInputs.geo : null);
  const seg = checklist.seg?.data || (userInputs?.seg?.length > 0 ? userInputs.seg : null);

  return (
    <div className="app">
      <header className="header">
        <div className="container header-inner">
          <div className="header-actions" style={{left: 0, right: 'auto'}}>
            <button className="btn btn-outline btn-sm" onClick={onBack}>&larr; Dashboard</button>
            <button className="btn btn-outline btn-sm" onClick={onBackToChecklist}>&#9998; Edit Data</button>
          </div>
          <span className="header-title">Stock Analyzer</span>
        </div>
      </header>
      <main className="main">
        <div className="container">
          <div className="detail-header">
            <h1 className="detail-title">{stock.name || stock.ticker}</h1>
            <span className="detail-ticker">{stock.ticker}</span>
          </div>

          <MetricsTable
            data={metricsData}
            overrides={overrides}
            onOverrideChange={handleOverrideChange}
          />

          <AiInsightsPanel insights={aiInsights} loading={aiLoading} error={aiError} />

          <div className="charts-grid">
            {(() => {
              const yrs = checklist._meta?.expectedYears || peSeries.length;
              const tag = yrs < DATA_YEARS ? `${yrs}Y` : '15Y';
              return <>
                <HistoryChart title={`${tag} PE Ratio`} series={peSeries} yLabel="PE" color="#4ADE80" formatFn={v => safePE(v).toString()} />
                <HistoryChart title={`${tag} PS Ratio`} series={psSeries} yLabel="PS" color="#A78BFA" formatFn={v => fmtNum(v)} />
                <HistoryChart title={`${tag} EBITDA`} series={ebitdaSeries} yLabel="EBITDA" color="#60A5FA" formatFn={v => '$' + fmtBigNum(v)} />
                <HistoryChart title={`${tag} Market Cap`} series={mktcapSeries} yLabel="Mkt Cap" color="#FB923C" formatFn={v => '$' + fmtBigNum(v)} />
                <HistoryChart title={`${tag} Free Cash Flow`} series={fcfSeries} yLabel="FCF" color="#22D3EE" formatFn={v => '$' + fmtBigNum(v)} />
                <PriceAlertChart prices1y={prices1y} significantDays={significantDays} />
              </>;
            })()}
          </div>

          <SupplementSection mktCapEbitda={mktCapEbitda} />

          <DistributionSection geo={geo} seg={seg} />

          <PriceAlertList alerts={alerts} loading={alertsLoading} />

          <MissingDataFooter checklist={checklist} />
        </div>
      </main>
    </div>
  );
}

// ============================================================
// SECTION 19: APP (Root Component)
// ============================================================
function App() {
  const [apiKeys, setApiKeysState] = useState(getApiKeys);
  const [showKeyModal, setShowKeyModal] = useState(!apiKeys.fmp || !hasAiKey(apiKeys));
  const [watchlist, setWatchlistState] = useState(getWatchlist);
  const [page, setPage] = useState('dashboard');
  const [selectedStock, setSelectedStock] = useState(null);
  const [loading, setLoading] = useState(false);
  const [loadingText, setLoadingText] = useState('');
  const [rawData, setRawData] = useState(null);
  const [checklist, setChecklist] = useState(null);
  const [showChecklist, setShowChecklist] = useState(false);
  const [checklistInputs, setChecklistInputs] = useState({});
  const [checklistSource, setChecklistSource] = useState('dashboard');
  const [detailVersion, setDetailVersion] = useState(0);
  const [proMode, setProMode] = useState(false);

  function handleSaveKeys(keys) {
    setApiKeys(keys);
    setApiKeysState(keys);
    setShowKeyModal(false);
  }

  function handleSetWatchlist(list) {
    setWatchlist(list);
    setWatchlistState(list);
  }

  async function handleSelectStock(stock) {
    setSelectedStock(stock);
    setLoading(true);
    setLoadingText('Fetching financial data for ' + stock.ticker + '...');
    try {
      const data = await fetchAllStockData(stock.ticker, apiKeys);
      setRawData(data);
      const cl = buildChecklist(data);
      setChecklist(cl);
      setLoading(false);
      // Restore previously saved user inputs for this ticker
      const saved = getUserInputs(stock.ticker);
      setChecklistInputs(saved);
      if (proMode) {
        setChecklistSource('dashboard');
        setShowChecklist(true);
      } else {
        setPage('detail');
      }
    } catch (err) {
      setLoading(false);
      alert('Error fetching data: ' + err.message);
    }
  }

  function handleChecklistConfirm(inputs) {
    const changed = JSON.stringify(inputs) !== JSON.stringify(checklistInputs);
    setChecklistInputs(inputs);
    if (selectedStock) saveUserInputs(selectedStock.ticker, inputs);
    setShowChecklist(false);
    setPage('detail');
    if (changed) setDetailVersion(v => v + 1);
  }

  function handleChecklistCancel() {
    if (checklistSource === 'detail') {
      setShowChecklist(false);
    } else {
      setShowChecklist(false);
      setSelectedStock(null);
      setRawData(null);
      setChecklist(null);
    }
  }

  function handleBackToChecklist() {
    setChecklistSource('detail');
    setShowChecklist(true);
  }

  function handleBackToDashboard() {
    setPage('dashboard');
    setSelectedStock(null);
    setRawData(null);
    setChecklist(null);
  }

  return (
    <>
      {showKeyModal && <ApiKeyModal keys={apiKeys} onSave={handleSaveKeys} />}
      {loading && <LoadingOverlay text={loadingText} />}
      {showChecklist && checklist && (
        <DataChecklistModal
          checklist={checklist}
          onConfirm={handleChecklistConfirm}
          onCancel={handleChecklistCancel}
          initialInputs={checklistInputs}
          cancelLabel={checklistSource === 'detail' ? '\u2190 Back to Details' : 'Back to Dashboard'}
          onAutoSave={inputs => { if (selectedStock) saveUserInputs(selectedStock.ticker, inputs); }}
        />
      )}
      {page === 'dashboard' && (
        <DashboardPage
          apiKeys={apiKeys}
          watchlist={watchlist}
          setWatchlist={handleSetWatchlist}
          onSelectStock={handleSelectStock}
          onOpenKeys={() => setShowKeyModal(true)}
          proMode={proMode}
          setProMode={setProMode}
        />
      )}
      {page === 'detail' && selectedStock && rawData && checklist && (
        <DetailPage
          key={detailVersion}
          stock={selectedStock}
          apiKeys={apiKeys}
          rawData={rawData}
          checklist={checklist}
          userInputs={checklistInputs}
          onBack={handleBackToDashboard}
          onBackToChecklist={handleBackToChecklist}
        />
      )}
    </>
  );
}

// ============================================================
// SECTION 20: RENDER
// ============================================================
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

  </script>
</body>
</html>
